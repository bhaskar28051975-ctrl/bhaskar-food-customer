<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Delivery Partner - Bhaskar Food</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-blue-50 pb-24 p-4">

    <div id="login-screen" class="hidden fixed inset-0 bg-blue-600 z-[200] flex items-center justify-center p-6">
        <div class="bg-white p-8 rounded-[3rem] w-full max-w-md shadow-2xl">
            <h2 class="text-2xl font-black text-blue-600 mb-2 uppercase italic">Driver Login</h2>
            <p class="text-[10px] text-gray-400 font-bold mb-6 uppercase">Enter details to track your commission</p>
            <input id="drName" type="text" placeholder="Your Full Name" class="w-full p-4 mb-3 border rounded-2xl bg-gray-50 font-bold">
            <input id="drPhone" type="tel" placeholder="Phone Number" class="w-full p-4 mb-6 border rounded-2xl bg-gray-50 font-bold">
            <button onclick="saveDriver()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-lg">START EARNING</button>
        </div>
    </div>

    <div class="max-w-md mx-auto space-y-6">
        <div class="bg-blue-600 p-8 rounded-[2.5rem] text-white shadow-xl relative overflow-hidden">
            <div class="relative z-10">
                <div class="flex justify-between items-start">
                    <div>
                        <p class="text-[10px] font-black uppercase opacity-70 tracking-widest">Your Current Earnings</p>
                        <h1 id="myEarnings" class="text-4xl font-black italic">‚Çπ0.00</h1>
                    </div>
                    <button onclick="settleEarnings()" class="bg-white/20 hover:bg-white/30 p-3 rounded-2xl transition-all active:scale-90" title="Settle & Clear History">
                        <i class="fa-solid fa-rotate text-xl"></i>
                    </button>
                </div>
                <p id="disp-name" class="text-[10px] mt-2 font-bold opacity-80 uppercase"></p>
            </div>
            <div class="absolute -right-4 -bottom-4 opacity-10 text-8xl"><i class="fa-solid fa-motorcycle"></i></div>
        </div>

        <h2 class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2">Orders Ready for Pickup</h2>
        <div id="delivery-list" class="space-y-4"></div>

        <hr class="border-blue-100">
        
        <h2 class="text-[10px] font-black text-gray-400 uppercase tracking-widest ml-2">Today's Unpaid History</h2>
        <div id="delivery-history" class="space-y-2"></div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, onValue, update, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = { 
            apiKey: "AIzaSyAT074ME7aIbb4R2VzgZZGdw8F3alL-xbA", 
            authDomain: "bhaskar-food-app.firebaseapp.com", 
            databaseURL: "https://bhaskar-food-app-default-rtdb.firebaseio.com", 
            projectId: "bhaskar-food-app", 
            appId: "1:712053690568:web:b4d8b789e0359ebc0e95fd" 
        };
        const app = initializeApp(firebaseConfig); 
        const db = getDatabase(app);

        const drPhone = localStorage.getItem('dr_p');
        let completedOrderKeys = []; // To keep track of keys for clearing

        // --- AUTH LOGIC ---
        window.saveDriver = () => {
            const n = document.getElementById('drName').value;
            const p = document.getElementById('drPhone').value;
            if(n && p) {
                localStorage.setItem('dr_n', n);
                localStorage.setItem('dr_p', p);
                location.reload();
            } else { alert("Please enter Name and Phone"); }
        };

        if(!drPhone) {
            document.getElementById('login-screen').classList.remove('hidden');
        } else {
            document.getElementById('disp-name').innerText = "Driver: " + localStorage.getItem('dr_n');
        }

        let currentRate = 0;
        onValue(ref(db, 'settings/commission'), s => {
            currentRate = parseFloat(s.val()) || 0;
        });

        // --- RENDER LOGIC ---
        onValue(ref(db, 'orders'), (snap) => {
            const list = document.getElementById('delivery-list');
            const history = document.getElementById('delivery-history');
            
            let totalComm = 0; 
            list.innerHTML = ""; 
            history.innerHTML = "";
            completedOrderKeys = []; 

            snap.forEach(child => {
                const o = child.val();
                const potentialComm = (parseFloat(o.totalAmount || 0) * currentRate / 100).toFixed(2);

                if(o.status === 'ready_for_pickup') {
                    list.innerHTML += `
                    <div class="bg-white p-6 rounded-[2rem] border-l-[10px] border-blue-500 shadow-sm">
                        <div class="flex justify-between items-start mb-2">
                            <p class="font-black text-gray-800 text-lg leading-tight">${o.customerName}</p>
                            <span class="bg-blue-100 text-blue-600 text-[10px] px-3 py-1 rounded-full font-black uppercase">Earn ‚Çπ${potentialComm}</span>
                        </div>
                        <p class="text-[11px] text-gray-500 font-bold italic mb-3">üìç ${o.location}</p>
                        <p class="text-xs text-gray-400 border-t pt-3 mb-4">${o.items}</p>
                        <button onclick="completeOrder('${child.key}')" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black uppercase text-xs shadow-md active:scale-95 transition-all">Mark as Delivered</button>
                    </div>`;
                } 
                // Only show 'completed' orders, 'settled' orders will be hidden
                else if (o.status === 'completed' && o.driverPhone === drPhone) {
                    const commissionAmount = parseFloat(o.commissionPaid || potentialComm);
                    totalComm += commissionAmount;
                    completedOrderKeys.push(child.key);

                    history.innerHTML += `
                    <div class="bg-white p-4 rounded-2xl flex justify-between items-center text-[10px] font-bold border border-gray-100 shadow-sm">
                        <div>
                            <p class="text-gray-800 uppercase">${o.customerName}</p>
                            <p class="text-gray-400 font-normal">Order Total: ‚Çπ${o.totalAmount}</p>
                        </div>
                        <span class="text-green-600 bg-green-50 px-3 py-2 rounded-xl">+ ‚Çπ${commissionAmount.toFixed(2)}</span>
                    </div>`;
                }
            });
            document.getElementById('myEarnings').innerText = "‚Çπ" + totalComm.toFixed(2);
        });

        // --- SETTLE & CLEAR LOGIC ---
        window.settleEarnings = () => {
            if (completedOrderKeys.length === 0) return alert("No earnings to settle!");
            
            if (confirm("Are you paid by the hotel? This will clear your current earnings display.")) {
                const updates = {};
                completedOrderKeys.forEach(key => {
                    updates[`orders/${key}/status`] = 'settled';
                });

                update(ref(db), updates).then(() => {
                    alert("Account Settled! Earnings reset to ‚Çπ0");
                });
            }
        };

        window.completeOrder = (orderId) => {
            get(ref(db, `orders/${orderId}`)).then((snapshot) => {
                if (snapshot.exists()) {
                    const orderData = snapshot.val();
                    const earned = (parseFloat(orderData.totalAmount) * currentRate / 100);
                    update(ref(db, `orders/${orderId}`), { 
                        status: 'completed', 
                        deliveredBy: localStorage.getItem('dr_n'),
                        driverPhone: localStorage.getItem('dr_p'),
                        commissionPaid: earned
                    });
                }
            });
        };
    </script>
</body>
</html>
